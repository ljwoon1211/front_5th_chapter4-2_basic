name: Lighthouse CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      url:
        description: "URL to run Lighthouse on"
        required: false
        default: "" # Firebase ë°°í¬ URLì„ ì‚¬ìš©í•˜ë¯€ë¡œ ê¸°ë³¸ê°’ì„ ë¹„ì›Œë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

permissions:
  issues: write
  contents: read

jobs:
  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Firebase ë°°í¬ ë‹¨ê³„ (ê¸°ì¡´ Vercel ë‹¨ê³„ ëŒ€ì²´)
      - name: Deploy to Firebase Hosting
        id: firebase-deploy # ë‹¨ê³„ ID ë³€ê²½
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}" # GitHub í† í° (í•„ìš”ì‹œ)
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FRONT_5TH_CHAPTER4_2BASIC }}" # Firebase ì„œë¹„ìŠ¤ ê³„ì • JSON (ì•„ë˜ì—ì„œ ì„¤ëª…)
          # ë˜ëŠ” firebaseToken: '${{ secrets.FIREBASE_TOKEN }}' # Firebase CI í† í° (ì•„ë˜ì—ì„œ ì„¤ëª…)
          channelId: live # í”„ë¡œë•ì…˜ ì±„ë„ì— ë°°í¬ (ë˜ëŠ” í•„ìš”ì— ë”°ë¼ preview ì±„ë„ ì‚¬ìš© ê°€ëŠ¥)
          projectId: front-5th-chapter4-2basic # ì—¬ê¸°ì— Firebase í”„ë¡œì íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.

      - name: Install dependencies for Lighthouse
        run: |
          npm install -g @lhci/cli@0.14.x
          # http-serverëŠ” Firebase ë°°í¬ ì‹œì—ëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤.

      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        run: |
          # Firebase ë°°í¬ URLì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
          # action-hosting-deploy@v0ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë°°í¬ëœ URLì„ ì¶œë ¥í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ,
          # Firebase í”„ë¡œì íŠ¸ì˜ ê¸°ë³¸ í˜¸ìŠ¤íŒ… URLì„ ì§ì ‘ ì‚¬ìš©í•˜ê±°ë‚˜,
          # Firebase í”„ë¡œì íŠ¸ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ˆì¸¡í•´ì•¼ í•©ë‹ˆë‹¤.
          # ì˜ˆ: https://front-5th-chapter4-2basic.web.app
          # ë˜ëŠ” inputs.urlì´ ì œê³µë˜ë©´ ê·¸ê²ƒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

          # firebase-deploy ë‹¨ê³„ì—ì„œ outputsì„ í†µí•´ URLì„ ì–»ì„ ìˆ˜ ìˆë‹¤ë©´ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤.
          # í˜„ì¬ FirebaseExtended/action-hosting-deploy@v0ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ URLì„ outputìœ¼ë¡œ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          # ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•ì€ Firebase Hostingì˜ ê¸°ë³¸ URL íŒ¨í„´ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
          FIREBASE_HOSTING_URL="https://front-5th-chapter4-2basic.web.app" # â˜…â˜…â˜… Firebase í”„ë¡œì íŠ¸ IDë¡œ êµì²´ â˜…â˜…â˜…

          if [ -n "${{ github.event.inputs.url }}" ]; then
            URL="${{ github.event.inputs.url }}"
            echo "ğŸ” Running Lighthouse on user provided URL: $URL"
          elif [ -n "$FIREBASE_HOSTING_URL" ]; then
            URL="$FIREBASE_HOSTING_URL"
            echo "ğŸ” Running Lighthouse on Firebase Hosting URL: $URL"
          else
            echo "ğŸš¨ Deployment URL not found!"
            exit 1
          fi
          lhci autorun --collect.url=$URL

      - name: Create GitHub Issue with Results
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              const lhciDir = '.lighthouseci';
              
              if (!fs.existsSync(lhciDir)) {
                throw new Error('Lighthouse CIê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .lighthouseci ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              }
              
              const jsonReports = fs.readdirSync(lhciDir).filter(f => f.endsWith('.json'));
              
              if (jsonReports.length === 0) {
                const dirContents = fs.readdirSync(lhciDir);
                throw new Error(`Lighthouse ë³´ê³ ì„œê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë””ë ‰í† ë¦¬ ë‚´ìš©: ${dirContents.join(', ')}`);
              }
              
              const latestReport = jsonReports.sort().reverse()[0];
              const reportPath = path.join(lhciDir, latestReport);
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

              const formatScore = (value = 0) => {
                return Math.round(value * 100);
              };

              const getEmoji = (value, metric) => {
                const thresholds = {
                  LCP: { good: 2500, needsImprovement: 4000 },
                  INP: { good: 200, needsImprovement: 500 },
                  CLS: { good: 0.1, needsImprovement: 0.25 },
                };
                
                if (!thresholds[metric]) return value >= 90 ? 'ğŸŸ¢' : value >= 50 ? 'ğŸŸ ' : 'ğŸ”´';
                
                const t = thresholds[metric];
                return value <= t.good ? 'ğŸŸ¢' : value <= t.needsImprovement ? 'ğŸŸ ' : 'ğŸ”´';
              };

              const formatMetric = (value, metric) => {
                if (!value) return 'N/A';
                if (metric === 'CLS') return value.toFixed(3);
                return `${(value / 1000).toFixed(2)}s`;
              };

              const getLighthouseResult = (report, category) => {
                try {
                  return report.categories?.[category]?.score ?? 0;
                } catch (e) {
                  return 0;
                }
              };

              const getMetricValue = (report, metric) => {
                try {
                  return report.audits?.[metric]?.numericValue ?? 0;
                } catch (e) {
                  return 0;
                }
              };

              const lighthouseScores = {
                performance: getLighthouseResult(report, 'performance'),
                accessibility: getLighthouseResult(report, 'accessibility'),
                'best-practices': getLighthouseResult(report, 'best-practices'),
                seo: getLighthouseResult(report, 'seo'),
                pwa: getLighthouseResult(report, 'pwa')
              };

              const webVitals = {
                LCP: getMetricValue(report, 'largest-contentful-paint'),
                INP: getMetricValue(report, 'experimental-interaction-to-next-paint'),
                CLS: getMetricValue(report, 'cumulative-layout-shift')
              };

              // Firebase ë°°í¬ URLì„ ì°¸ì¡°í•˜ë„ë¡ ìˆ˜ì •
              const deploymentUrl = `https://front-5th-chapter4-2basic.web.app`; // â˜…â˜…â˜… Firebase í”„ë¡œì íŠ¸ IDë¡œ êµì²´ â˜…â˜…â˜…
              // const deploymentUrl = steps['firebase-deploy'].outputs.deployment_url; // ë§Œì•½ ì•¡ì…˜ì´ URLì„ outputìœ¼ë¡œ ì œê³µí•œë‹¤ë©´ ì´ì™€ ê°™ì´ ì‚¬ìš©
              const testedUrl = "${{ github.event.inputs.url }}" || deploymentUrl;


              const body = `## ğŸš¨ ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼

              ${deploymentUrl ? `### ğŸš€ ë°°í¬ ì •ë³´\n**Firebase ë°°í¬ URL**: ${deploymentUrl}\n` : ''}

              ### ğŸ¯ Lighthouse ì ìˆ˜
              | ì¹´í…Œê³ ë¦¬ | ì ìˆ˜ | ìƒíƒœ |
              |----------|------|------|
              | Performance | ${formatScore(lighthouseScores.performance)}% | ${getEmoji(formatScore(lighthouseScores.performance))} |
              | Accessibility | ${formatScore(lighthouseScores.accessibility)}% | ${getEmoji(formatScore(lighthouseScores.accessibility))} |
              | Best Practices | ${formatScore(lighthouseScores['best-practices'])}% | ${getEmoji(formatScore(lighthouseScores['best-practices']))} |
              | SEO | ${formatScore(lighthouseScores.seo)}% | ${getEmoji(formatScore(lighthouseScores.seo))} |
              | PWA | ${formatScore(lighthouseScores.pwa)}% | ${getEmoji(formatScore(lighthouseScores.pwa))} |

              ### ğŸ“Š Core Web Vitals (2024)
              | ë©”íŠ¸ë¦­ | ì„¤ëª… | ì¸¡ì •ê°’ | ìƒíƒœ |
              |--------|------|--------|------|
              | LCP | Largest Contentful Paint | ${formatMetric(webVitals.LCP, 'LCP')} | ${getEmoji(webVitals.LCP, 'LCP')} |
              | INP | Interaction to Next Paint | ${formatMetric(webVitals.INP, 'INP')} | ${getEmoji(webVitals.INP, 'INP')} |
              | CLS | Cumulative Layout Shift | ${formatMetric(webVitals.CLS, 'CLS')} | ${getEmoji(webVitals.CLS, 'CLS')} |

              ### ğŸ“ Core Web Vitals ê¸°ì¤€ê°’
              - **LCP (Largest Contentful Paint)**: ê°€ì¥ í° ì½˜í…ì¸ ê°€ í™”ë©´ì— ê·¸ë ¤ì§€ëŠ” ì‹œì  
                - ğŸŸ¢ Good: < 2.5s
                - ğŸŸ  Needs Improvement: < 4.0s
                - ğŸ”´ Poor: â‰¥ 4.0s

              - **INP (Interaction to Next Paint)**: ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì— ëŒ€í•œ ì „ë°˜ì ì¸ ì‘ë‹µì„±
                - ğŸŸ¢ Good: < 200ms
                - ğŸŸ  Needs Improvement: < 500ms
                - ğŸ”´ Poor: â‰¥ 500ms

              - **CLS (Cumulative Layout Shift)**: í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ë ˆì´ì•„ì›ƒ ë³€ê²½ì˜ ì •ë„
                - ğŸŸ¢ Good: < 0.1
                - ğŸŸ  Needs Improvement: < 0.25
                - ğŸ”´ Poor: â‰¥ 0.25

              > ğŸ“… ì¸¡ì • ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
              > ğŸŒ ì¸¡ì • URL: ${testedUrl}`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ“Š ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼ (Firebase) - ${new Date().toLocaleString('ko-KR', { 
                  timeZone: 'Asia/Seoul',
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: false
                })}`,
                body: body,
                labels: ['lighthouse-audit', 'web-vitals', 'firebase']
              });
              
            } catch (error) {
              console.error('âŒ ì—ëŸ¬ ë°œìƒ:', error.message);
              
              // Firebase ë°°í¬ URLì„ ì°¸ì¡°í•˜ë„ë¡ ìˆ˜ì •
              const deploymentUrl = `https://front-5th-chapter4-2basic.web.app`; // â˜…â˜…â˜… Firebase í”„ë¡œì íŠ¸ IDë¡œ êµì²´ â˜…â˜…â˜…
              // const deploymentUrl = steps['firebase-deploy'].outputs.deployment_url; // ë§Œì•½ ì•¡ì…˜ì´ URLì„ outputìœ¼ë¡œ ì œê³µí•œë‹¤ë©´
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âŒ Lighthouse ì‹¤í–‰ ì‹¤íŒ¨ (Firebase) - ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}`,
                body: `## âŒ Lighthouse ì‹¤í–‰ ì‹¤íŒ¨
                
                ${deploymentUrl ? `### ğŸš€ ë°°í¬ ì •ë³´\n**Firebase ë°°í¬ URL**: ${deploymentUrl} (ë°°í¬ëŠ” ì„±ê³µí–ˆì„ ìˆ˜ ìˆìŒ)\n` : ''}
                
                **ì—ëŸ¬ ë©”ì‹œì§€**: ${error.message}
                
                **ê°€ëŠ¥í•œ ì›ì¸**:
                1. lighthouserc.js íŒŒì¼ì´ ì—†ìŒ
                2. ëŒ€ìƒ URLì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ (Firebase ë°°í¬ í™•ì¸ í•„ìš”)
                3. Lighthouse CI ì‹¤í–‰ ì‹¤íŒ¨
                
                **í•´ê²° ë°©ë²•**:
                1. lighthouserc.js íŒŒì¼ì„ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìƒì„±
                2. ë°°í¬ëœ Firebase ì‚¬ì´íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
                3. GitHub Actions ë¡œê·¸ í™•ì¸
                
                > ğŸ“… ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}`,
                labels: ['lighthouse-audit', 'error', 'firebase']
              });
            }
